<?php
/**
 * checkout_success header_php.php
 *
 * @package page
 * @copyright Copyright 2003-2007 Zen Cart Development Team
 * @copyright Portions Copyright 2003 osCommerce
 * @license http://www.zen-cart.com/license/2_0.txt GNU Public License V2.0
 * @version $Id: header_php.php 6373 2007-05-25 20:22:34Z drbyte $
 */
// This should be first line of the script:
$zco_notifier->notify('NOTIFY_HEADER_START_CHECKOUT_SUCCESS');

// if the customer is not logged on, redirect them to the shopping cart page
if (!$_SESSION['customer_id']) {
  zen_redirect(zen_href_link(FILENAME_TIME_OUT));
}

$notify_string='';
if (isset($_GET['action']) && ($_GET['action'] == 'update')) {
  $notify_string = 'action=notify&';
  $notify = $_POST['notify'];

  if (is_array($notify)) {
	 for ($i=0, $n=sizeof($notify); $i<$n; $i++) {
		$notify_string .= 'notify[]=' . $notify[$i] . '&';
	 }
	 if (strlen($notify_string) > 0) $notify_string = substr($notify_string, 0, -1);
  }
  if ($notify_string == 'action=notify&') {
		zen_redirect(zen_href_link(FILENAME_CHECKOUT_SUCCESS, '', 'SSL'));
  } else {
	 zen_redirect(zen_href_link(FILENAME_DEFAULT, $notify_string));
  }
}

require(DIR_WS_MODULES . zen_get_module_directory('require_languages.php'));
require (DIR_WS_LANGUAGES . $_SESSION['language'] . '/account_history_info.php');
//$breadcrumb->add(NAVBAR_TITLE_1);
//$breadcrumb->add(NAVBAR_TITLE_2);

// find out the last order number generated for this customer account
$orders_query = "SELECT * FROM " . TABLE_ORDERS . "
					  WHERE customers_id = :customersID
					  ORDER BY date_purchased DESC LIMIT 1";
$orders_query = $db->bindVars($orders_query, ':customersID', $_SESSION['customer_id'], 'integer');
$orders = $db->Execute($orders_query);
$orders_id = $orders->fields['orders_id'];
$ls_payment_module = $orders->fields['payment_module_code'];

// use order-id generated by the actual order process
// this uses the SESSION orders_id, or if doesn't exist, grabs most recent order # for this cust (needed for paypal et al).
// Needs reworking in v1.4 for checkout-rewrite
$zv_orders_id = (isset($_SESSION['order_number_created']) && $_SESSION['order_number_created'] >= 1) ? $_SESSION['order_number_created'] : $orders_id;
$orders_id = $zv_orders_id;
//unset($_SESSION['order_number_created']);

// prepare list of product-notifications for this customer
$global_query = "SELECT global_product_notifications
					  FROM " . TABLE_CUSTOMERS_INFO . "
					  WHERE customers_info_id = :customersID";

$global_query = $db->bindVars($global_query, ':customersID', $_SESSION['customer_id'], 'integer');
$global = $db->Execute($global_query);
$flag_global_notifications = $global->fields['global_product_notifications'];

if ($flag_global_notifications != '1') {

  $products_array = array();
  $counter = 0;

  $products_query = "SELECT products_id, products_name
							FROM " . TABLE_ORDERS_PRODUCTS . "
							WHERE orders_id = :ordersID
							ORDER BY products_name";

  $products_query = $db->bindVars($products_query, ':ordersID', $orders_id, 'integer');
  $products = $db->Execute($products_query);

  while (!$products->EOF) {
	 $notificationsArray[] = array('counter'=>$counter,
											 'products_id'=>$products->fields['products_id'],
											 'products_name'=>$products->fields['products_name']);
	 $counter++;
	 $products->MoveNext();
  }
}

  $flag_show_products_notification = (CUSTOMERS_PRODUCTS_NOTIFICATION_STATUS == '1' and sizeof($notificationsArray)>0 and $flag_global_notifications != '1') ? true : false ;

  $products_displayed = array();


  $gv_query = "SELECT amount
					FROM " . TABLE_COUPON_GV_CUSTOMER . "
					WHERE customer_id = :customersID ";

  $gv_query = $db->bindVars($gv_query, ':customersID', $_SESSION['customer_id'], 'integer');
  $gv_result = $db->Execute($gv_query);

  if ($gv_result->fields['amount'] > 0 ) {
	 $customer_has_gv_balance = true;
	 $customer_gv_balance = $currencies->format($gv_result->fields['amount']);
  }


// include template specific file name defines
$define_page = zen_get_file_directory(DIR_WS_LANGUAGES . $_SESSION['language'] . '/html_includes/', FILENAME_DEFINE_CHECKOUT_SUCCESS, 'false');

//jessa 2010-02-24 �ڹ˿�checkout֮��$_SESSION['sendto']��ֵ����
$_SESSION['reset_shipping_fee'] = 'false';
//eof jessa 2010-02-24

/**
* smarty
*/
require(DIR_WS_CLASSES . 'order.php');
$order = new order($orders_id);
$get_vip_amount_sql = "select value from " . TABLE_ORDERS_TOTAL . " where class='ot_group_pricing' and orders_id = " . $orders_id;
$get_vip_amount = $db->Execute ( $get_vip_amount_sql );
if ($get_vip_amount->RecordCount () > 0) {
	$get_sub_total_sql = "select value from " . TABLE_ORDERS_TOTAL . " where class='ot_subtotal' and orders_id = " . $orders_id;
	$get_sub_total = $db->Execute ( $get_sub_total_sql );
	$vip_discount = "(" . (round ( $get_vip_amount->fields ['value'] / $get_sub_total->fields ['value'], 2 ) * 100) . "% off)";
} else {
	$vip_discount = "";
}
for ($i = 0, $n = sizeof($order->totals); $i < $n; $i++){
	$str .= '<tr>' . "\n";
	if($order->totals[$i]['class'] == 'ot_total' ){
		$title =' <td align="right"><b>' . TABLE_HEADING_TOTAL . ':</b></td>' . "\n";
		$str .= $title.' <td><ins>' . $order->totals[$i]['text'] . '</ins></td>' . "\n";
	}else{
		if($order->totals[$i]['class'] == 'ot_subtotal'){
			$order->totals[$i]['title'] = TEXT_CART_TOTAL_PRODUCT_PRICE . ':';
			$order->totals[$i]['text'] = $currencies->format($order->totals[$i]['value'], true, $order->info['currency']);
		}
		if($order->totals[$i]['class'] == 'ot_shipping'){
			$order->totals[$i]['title'] = TEXT_SHIPPING_CHARGE;
		}
		if($order->totals[$i]['class'] == 'ot_coupon'){
			require (DIR_WS_LANGUAGES . $_SESSION ['language'] . '/modules/order_total/ot_coupon.php');
			$title_discoupon = $order->totals [$i] ['title'];
			$first_order = false;
			if(in_array(preg_replace("/(\s|\&nbsp\;|　|\xc2\xa0)/","",$title_discoupon), array('NewCustomerCoupon:','RabattderersteBestellung:','Скидкадляпервогозаказа:','Discountde1èrecommande:' ))) {
				$first_order =  true;
				$order->totals[$i]['title'] = MODULE_ORDER_TOTAL_COUPON_TITLE_FIRST . ':';
			} else {
				$order->totals[$i]['title'] = 'RCD:';
			}
		}
		if($order->totals[$i]['class'] == 'ot_cash_account'){
			$order->totals[$i]['title'] = TEXT_CREDIT_BALANCE;
		}
		if($order->totals[$i]['class'] == 'ot_promotion'){
			require (DIR_WS_LANGUAGES . $_SESSION ['language'] . '/modules/order_total/ot_promotion.php');
			$order->totals[$i]['title'] = TEXT_PROMOTION_DISCOUNT;
		}
		if($order->totals[$i]['class'] == 'ot_group_pricing'){
			$order->totals[$i]['title'] = TEXT_CART_VIP_DISCOUNT . ':';
		}
		if(substr($order->totals[$i]['text'],0,1) == '-'){
			if ($order->totals [$i] ['class'] == 'ot_group_pricing') {
				$text = ' <td>(-) ' . substr($order->totals[$i]['text'],1) . '</td>';
			}else {
				$text = ' <td>(-) ' . substr($order->totals[$i]['text'],1) . '</td>';
			}
			if ($order->totals [$i] ['class'] == 'ot_coupon' && !$first_order) {
				$text = ' <td>(-) ' . substr($order->totals[$i]['text'],1) . ' (3% '.TEXT_DISCOUNT_OFF.')</td>';
			}else {
				$text = ' <td>(-) ' . substr($order->totals[$i]['text'],1) . '</td>';
			}
		}else{
			$text = ' <td>'.($order->totals[$i]['text']==TEXT_FREE_SHIPPING ? '' : '(+)').$order->totals[$i]['text'] . '</td>';
		}
		$str .= ' <td valign="top" align="right">' . $order->totals[$i]['title']. '</td>'.$text;
	}
	$str .='</tr>' . "\n";
}
$order_query = "select	orders_status,order_total, delivery_country_iso_code_2
								from " . TABLE_ORDERS . "
								where orders_id = '" . (int)$orders_id . "' limit 1";
$orders_status = $db->Execute($order_query);

$delivery_country_iso_code_2 = $orders_status->fields['delivery_country_iso_code_2'];

$use_new_template = true; //new templates for smarty
$message = array();
$message['success_date'] = zen_date_short(date('Y-m-d'));
$message['success_orders_id'] = $orders_id;
$message['success_order_number'] = TEXT_SUCC_ORDER_NUMBER;
$message['success_payment_method'] = TEXT_SUCC_PAYMENT_METHOD;
$message['success_payment_method_text'] = $order->info['payment_method'];
$message['success_shipping_method_text'] = $order->info['shipping_method'];
$message['success_order_status'] = $orders_status->fields['orders_status'];

if((isset($_SESSION['is_old_customers']) && $_SESSION['is_old_customers'] == 0 ) && in_array($orders_status->fields['orders_status'], explode(',', MODULE_ORDER_PAID_VALID_DELIVERED_UNDER_CHECKING_STATUS_ID_GROUP))){
    $db->Execute('update ' . TABLE_CUSTOMERS . ' set is_old_customers = 1 where customers_id= "' . $_SESSION['customer_id'] . '"' );
}

if($orders_status->fields['orders_status'] == 2 || $orders_status->fields['orders_status'] == 42){
	$message['success_successfully'] = TEXT_SUCCESSFULLY;
	if(date('Y-m-d H:i:s') < '2014-04-24 16:00:00'){
		$coupon_code = '';
		if($orders_status->fields['order_total'] > 99 && $orders_status->fields['order_total'] < 999){
			$coupon_code = 'CP2014040901';
		}elseif($orders_status->fields['order_total'] > 999 && $orders_status->fields['order_total'] < 1999){
			$coupon_code = 'CP2014040902';
		}elseif($orders_status->fields['order_total'] > 1999){
			$coupon_code = 'CP2014040903';
		}
		if($coupon_code != ''){
			$sql_coupon = 'select coupon_id,coupon_amount from  ' .  TABLE_COUPONS . '  where coupon_code = "'.$coupon_code.'" limit 1';
			$result_coupon = $db->Execute($sql_coupon);
			if($result_coupon->RecordCount() > 0){
				$order_coupon = $db->Execute("select cc_orders_id from " . TABLE_COUPON_CUSTOMER . " where cc_orders_id = " . (int)$orders_id . " and cc_customers_id =  ".$_SESSION['customer_id']." and cc_coupon_id = ".$result_coupon->fields['coupon_id']." limit 1");
				if($order_coupon->RecordCount() == 0){
					$db->Execute( "INSERT INTO  ".TABLE_COUPON_CUSTOMER." (`cc_coupon_id` ,`cc_customers_id` ,`cc_amount`,`cc_orders_id`,`cc_coupon_status`,`date_created`)VALUES (".$result_coupon->fields['coupon_id'].",  ".$_SESSION['customer_id'].",  '', " . (int)$orders_id . ", 10, now());");
				}
			}
		    $message['set_coupon'].=sprintf(TEXT_SET_COUPON,'$'.(int)$result_coupon->fields['coupon_amount']);
		}
	}

	//	20150422 xiaoyong.lv
	if($orders_status->fields['orders_status'] == 2){
		$send_res = present_promotion_coupon($orders_id);
		if($send_res>0){
			$message['success_successfully'] .= '<br/>'.sprintf(TEXT_PRESENT_COUPON, $currencies->format($send_res, true, $order->info['currency']));
		}
	}

	//	invite frineds 20150422 xiaoyong.lv
	$fun_inviteFriends->sendCoupon($orders_id);
}else{
	$message['success_successfully'] = TEXT_SUCC_THANK_PAYMENT . $message['success_payment_method_text'].'.';
}

$order->delivery['telephone_number'] = $order->customer['telephone'];

$order_comments = $db->Execute("select orders_id,comments from " . TABLE_ORDERS_STATUS_HISTORY . " where orders_id = " . (int)$orders_id . " order by date_added asc limit 1");
if(isset($order_comments->fields['comments']) && trim($order_comments->fields['comments']) != ''){
	//$order_comments->fields['comments'] = str_replace(array('#D5#','#BD#'),array('',''), $order_comments->fields['comments']);
	$message['order_comments'] = htmlentities($order_comments->fields['comments'],ENT_NOQUOTES,"utf-8");
	$message['order_comments'] = str_replace("#D5#",TEXT_REORDER_PACKING_WAY_ONE.'<br/>',$message['order_comments']);
	$message['order_comments'] = str_replace("#BD#",TEXT_REORDER_PACKING_WAY_TWO.'<br/>',$message['order_comments']);
	$message['order_comments'] = str_replace("#D15#",TEXT_REORDER_PACKING_WAY_THREE.'<br/>',$message['order_comments']);
	$message['order_comments'] = str_replace("#D#",TEXT_REORDER_PACKING_WAY_FOUR.'<br/>',$message['order_comments']);
	$message['order_comments'] = str_replace("#15FA#",TEXT_REORDER_PACKING_WAY_FIVE.'<br/>',$message['order_comments']);	
}else{
	$message['order_comments'] = '/';
}

//	get products for your consideration
$recent_products_query = "SELECT p.products_id, pd.products_name, p.products_image 
								 FROM " . TABLE_PRODUCTS . " p, " . TABLE_PRODUCTS_DESCRIPTION . " pd, " . TABLE_FEATURED . " f 
								 WHERE p.products_status = 1 and p.products_id = f.products_id and f.status = 1
								 AND pd.products_id = f.products_id
								 AND p.products_id = pd.products_id and pd.language_id = " . $_SESSION ['languages_id'];
$recent_products = $db->ExecuteRandomMulti($recent_products_query,6);
$products_for_your = array();
if ($recent_products->RecordCount() > 0){
	$customer_basket_products = zen_get_customer_basket ();
	$page_type = 8;
	$page_name = 'quick_view';
	while (!$recent_products->EOF){
		$product_id = $recent_products->fields ['products_id'];
		$recent_products->fields ['products_quantity'] = zen_get_products_stock($product_id);
		$product_quantity = $recent_products->fields ['products_quantity'];
		$product_image = $recent_products->fields ['products_image'];
		$product_name = $recent_products->fields ['products_name'];
		
//		if (isset ( $customer_basket_products [$product_id] )) {
//			$procuct_qty = $customer_basket_products [$product_id];
//			$bool_in_cart = 1;
//		} else {
			$procuct_qty = 0;
			$bool_in_cart = 0;
//		}
			
		$discount_amount = zen_show_discount_amount ( $product_id );
		$discount = $discount_amount > 0 ? draw_discount_img($discount_amount, 'div','discountbg')/* '<div class="discountbg">' . $discount_amount . '%<br/>off</div>' */ : '';
		$products_for_your [$disp_sum] ['img'] = '<div class="galleryimg">'.$discount.'<p class="galleryimgshow"><a title="' . htmlspecialchars ( zen_clean_html ( $product_name ) ) . '" href="' . zen_href_link ( FILENAME_PRODUCT_INFO, 'products_id=' . $product_id  ) . '"><img class="lazy-img" src="/includes/templates/cherry_zen/images/loading/130.gif" data-size="130" data-lazyload=="' . HTTPS_IMG_SERVER . 'bmz_cache/' . get_img_size ( $product_image, 130, 130 ) . '" alt="' . htmlspecialchars ( zen_clean_html ( $product_name ) ) . '"></a></p></div>';
		$products_for_your [$disp_sum] ['name'] = '<p class="ptext"><a title="' . htmlspecialchars ( zen_clean_html ( $product_name ) ) . '" href="' . zen_href_link ( FILENAME_PRODUCT_INFO, 'products_id=' . $product_id ) . '">' . getstrbylength ( htmlspecialchars ( zen_clean_html ( $product_name ) ), 32 ) . '</a></p>';
		
		$unit_price = zen_get_unit_price($product_id);
		if($_SESSION['languages_id']==3 && $_SESSION['currency']=='RUB' && $unit_price!=''){
			$products_for_your [$disp_sum] ['price'] = $unit_price;
		}else{
			$products_for_your [$disp_sum] ['price'] = zen_get_products_display_price_new ( $product_id, 'foryour_consider' );
		}
		
		$products_for_your [$disp_sum] ['button'] = '<div class="detailinput"><p>';
		if ($product_quantity > 0) {
			$products_for_your [$disp_sum] ['button'] .= '<input class="qty addcart_qty_input" maxlength="5" orig_value="' . ($bool_in_cart ? $procuct_qty : 1) . '" type="text" id="' . $page_name . '_' . $product_id . '" name="products_id[' . $product_id . ']" value="' . ($bool_in_cart ? $procuct_qty : 1) . '" /><input type="hidden" id="MDO_' . $product_id . '" value="' . $bool_in_cart . '" /><input type="hidden" id="incart_' . $product_id . '" value="' . $procuct_qty . '" /><a href="javascript:void(0);" class="' . ($bool_in_cart ? 'icon_updates' : 'icon_addcart') . '" id="submitp_' . $product_id . '" onclick="Addtocart_list(' . $product_id . ',' . $page_type . ', this); return false;"></a>';
		} else {
			if($products_best_seller->fields['is_sold_out'] == 1){
				$products_for_your [$disp_sum] ['button'] .= '<span class="soldout_text"><a id="restock_' . $product_id . '" onclick="beforeRestockNotification(' . $product_id . '); return false;">' . TEXT_RESTOCK . '<br>' . TEXT_NOTIFICATION . '</a></span>';
				$products_for_your [$disp_sum] ['button'] .= '<a class="cartout" href="javascript:void(0);"></a>';
			}else{
				$products_for_your [$disp_sum] ['button'] .= '<input class="qty addcart_qty_input" maxlength="5" orig_value="' . ($bool_in_cart ? $procuct_qty : 1) . '" type="text" id="' . $page_name . '_' . $product_id . '" name="products_id[' . $product_id . ']" value="' . ($bool_in_cart ? $procuct_qty : 1) . '" /><input type="hidden" id="MDO_' . $product_id . '" value="' . $bool_in_cart . '" /><input type="hidden" id="incart_' . $product_id . '" value="' . $procuct_qty . '" /><a href="javascript:void(0);" class="' . ($bool_in_cart ? 'icon_updates' : 'icon_addcart') . '" id="submitp_' . $product_id . '" onclick="Addtocart_list(' . $product_id . ',' . $page_type . ', this); return false;"></a>';
				$backtip = '<div class="clearfix"></div><div style="color:#999">'.($products_best_seller->fields['products_stocking_days'] > 7 ? TEXT_AVAILABLE_IN715 : TEXT_AVAILABLE_IN57).'</div>';
			}
		}
		$products_for_your [$disp_sum] ['button'] .= '<a class="addcollect" title="' . HEADER_TITLE_WISHLIST . '" id="wishlist_' . $product_id . '" class="addwishlistbutton" onclick="beforeAddtowishlist(' . $product_id . ',' . $page_type . '); return false;" href="javascript:void(0);"></a>';
		$products_for_your [$disp_sum] ['button'] .= '</p>';
		$products_for_your [$disp_sum] ['button'] .= '<div class="successtips_add successtips_add1"><span class="bot"></span><span class="top"></span><ins class="sh">' . TEXT_ENTER_RIGHT_QUANTITY . '</ins></div>';
		$products_for_your [$disp_sum] ['button'] .= '<div class="successtips_add successtips_add2"><span class="bot"></span><span class="top"></span><ins class="sh"></ins></div>';
		$products_for_your [$disp_sum] ['button'] .= '<div class="successtips_add successtips_add3"><span class="bot"></span><span class="top"></span><ins class="sh"></ins></div></div>';
		$products_for_your [$disp_sum] ['button'] .= $backtip;
		$backtip = '';
		$disp_sum ++;

		$recent_products->MoveNextRandom();
	}
}
$smarty->assign ('products_for_your', $products_for_your);

$message['success_payment_detailas'] = TEXT_PAYMENT_DETAILS;
$message['success_invoice_value'] = TEXT_SUCC_INVOICE_VALUE;
$message['success_invoice_shipping_fee'] = TEXT_SUCC_INVOICE_SHIPPING_FEE;
$message['success_invoice_item_description'] = TEXT_SUCC_ITEM_DESCRIPTION;
$message['success_shipping_address'] = TEXT_SHIPPING_ADDRESS;
$message['success_order_cumments'] = TEXT_ORDER_COMMONTS;
$message['success_order_details'] = zen_href_link(FILENAME_ACCOUNT_HISTORY_INFO, 'order_id=' . $orders_id, 'SSL');
$message['success_order_shipping_address'] = zen_address_format_order($order->delivery['format_id'], $order->delivery, 1, '', '&nbsp;');
$message['success_order_total'] = $str;
$message['success_order_detail'] = TEXT_SUCC_ORDER_DETAIL;
$message['success_shipping_invoece_comments'] = TEXT_SHIPPING_INVOECE_COMMENTS;
$message['success_you_ve_made_payment'] = TEXT_HAVE_MADE_PAYMENT;
$message['success_payment_under_checking'] = TEXT_PAYMENT_UNDER_CHECKING;
$message['success_shipping_method'] = TEXT_SHIPPING_METHOD;
$message['text_view_invoice'] = TEXT_VIEW_INVOICE;


require(DIR_WS_CLASSES . 'shipping.php');
$shipping_modules = new shipping($order->info['shipping_module_code']);
$time_unit = TEXT_DAYS_LAN;
if ($shipping_modules->shipping_method[$order->info['shipping_module_code']]['time_unit'] == 20) {
	$time_unit = TEXT_WORKDAYS;
}
//$message['shipping_days'] = $shipping_modules->shipping_method[$order->info['shipping_module_code']]['days'].'&nbsp;'.$time_unit;
$shipping_days_array = $shipping_modules->get_shipping_day($order->info['shipping_module_code'], $delivery_country_iso_code_2, $order->delivery['postcode']);
$message['shipping_days'] = implode('-', $shipping_days_array) . $time_unit;

$smarty->assign('order', $order);
$smarty->assign('message', $message);
$smarty->caching = 0;


// This should be last line of the script:
$zco_notifier->notify('NOTIFY_HEADER_END_CHECKOUT_SUCCESS');
?>